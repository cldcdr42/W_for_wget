 # После Hello-world. Выполнение заданий по работе в кластере k8s

 ## Содержание
- [Счетчик успешного выполнения работы по гайду](#Счетчик-успешного-выполнения-работы-по-гайду)
- [Поднятие бд и и приложения](#Поднятие-бд-и-приложения)
- [Галочка за ингрес (ING)](#Галочка-за-ингрес)
- [Ошибка лимита пулов в докерхаб](#Ошибка-лимита-пулов-в-докерхаб)
- [Если у меня свое приложение и бд?](#Если-у-меня-свое-приложение-и-бд)

# Важно:
 #№ Убедитесь в том, что неймспейсы как в файлах, так и при выполнении команд, являются вашими. Читайте инструкции
 Что-то не работает? Повторите все выполненные команды `wget -O <file> <url>` и `kubectl apply -f <file> -n ns-<xx>`  
 Для информация об ошибках используйте
 ```
 # получить список моих подов, ns-<xx> заменить на свой
 kubectl get pods -n ns-<xx>
 # пример названия пода: postgres-dep-32dw1jd98a-wda2d

 # получить статус подов
 kubectl describe pod <podname> -n ns-<xx>

 # получить инфомрацию о работе программ внутри подов
 kubectl logs <podname> -n ns-<xx>
 ```

---

 # Счетчик успешного выполнения работы по гайду
 Известные мне на текущий момент: 2  
 Сработает ли это у вас? Возможно
 

 # Поднятие бд и приложения
 На основе моего хода решения:

 (Не тестировал все шаги с 0, поэтому что-то может в гайде не сработать) (Есть прецедент успешного запуска бд и приложения по этому гайду)

1) Создадим папки, куда будем хранить файлы
 
```
cd ~ && mkdir app && cd app
```

2) Скачать конфигурации базы данных и приложения для запуска в кластере
  
 ```
 wget -O postgres.yml https://shorturl.at/oHfxZ
 wget -O python.yml https://shorturl.at/iqxAS
 ```

3) заменить неймспейсы на свои  
   ==== ОБЯЗАТЕЛЬНО  ====    
   ==== ОБЯЗАТЕЛЬНО  ====  
   ==== ОБЯЗАТЕЛЬНО  ====    
   В двух местах в файле postgres.yml  
   ```
   nano postgres.yml
   ```
   Найти строчки namespace: ns-32  
   Заменить на свои  
   Когда закончили менять, нажмите CTRL+X, затем y (от англиского yes) и Enter    
  
   В двух местах в файле python.yml  
   ```
   nano python.yml
   ```
   Найти строчки namespace: ns-32   
   Заменить на свои  
   Когда закончили менять, нажмите CTRL+X, затем y (от англиского yes) и Enter  

5) Выполнить деплой данных конфигураций. Вместе ns-<xx> указать свой неймспей. Например, ns-57
   ```
   kubectl apply -f postgres.yml -n ns-<xx>
   kubectl apply -f python.yml -n ns-<xx>
   ```
   Рекомендую сначала дождаться запуска (Running) БД, затем - начинать команду запуска приложения

   Если с деплоем что-то не так, отменить его можно (вместо python.yml вставьте название нужного файла)
   ```
   kubectl delete -f python.yml -n ns-<xx>
   ```

7) Дождаться момента, когда все поды получат статус Running (ns-<xx> заменить на свой)
   ```
   kubectl get pods -n ns-<xx>
   ```

8) Когда все готово, можно демонстрировать работу программы. Для этого
   Прокидываем порты с локальной машины (nx-<xx> заменить на свой)
   ```
   kubectl port-forward svc/python-app-svc 5000:5000 -n ns-<xx> &
   ```
   И выполняем запрос. В скобках '{"number": 1}' вместо 1 можно выбрать любое натуральное число от 1 до 100 [1;99]
   ```
   curl -X POST -H "Content-Type: application/json" -d '{"number": 1}' http://localhost:5000/process
   ```
   В случае успеха должно появиться сообщение (Если ввели число X)
   ```
   "Response: {X + 1}. Number {X} has been added to the database."
   ```
   Если до демонстрации уже добавляли числа, возможны два других ответа:
   ```
   Number {X} is already in the database (case 1)
   ```
   ИЛИ
   ```
   Number {num + 1} is already in the database (case 2)
   ```
   Если ответа нет в принципе, то все плохо
   Этого достаточно для получения галочек ENV, Docker, REST, kube, db (5 штук)


# Галочка за ингрес

1) Скачать конфигурацию ингресса
```
wget -O ingress.yml https://shorturl.at/zt2mX
```

2) Заменить в файле ингреса строку namespace: ns-32 на свою, вместо <my-cool-domain.com> указать любой выдуманный домен
```
nano ingress.yml
```

Заменить домен на свой. Вместо my_cool_domain.com можно использовать что угодно, например, test1234.ru; helloworld; hepl111.com
```
host: my_cool_domain.com
```

Работа с файлом завершена, сохраняем: CTRL+x, y, Enter

3) Запустить ингресс. Заменить ns-<xx> на свой
```
kubectl apply -f ingress.yml -n ns-<xx>
```

3.5) Проверить ингресс можно командой ниже. Заменить ns-<xx> на свой
```
kubectl get ingress -n ns-<xx>
```

3) Узнать ip
```
kubectl het svc -n haproxy-controller
```
Должен быть 10.98.8.45

4) Добавить ip (найден прошлой командой). Замените my_cool_domain.com на то, что придумали в файле ingress.yml
```
sudo nano /etc/hosts
10.98.8.45 my_cool_domain.com
```
CTRL+x, y, Enter

5) Выполните запрос. Вместо my-cool-domain.com написать тот домен, который вы указывали раньше.
```
curl -X POST -H "Content-Type: application/json" -d '{"number": 1}' http://my-cool-domain.com/process
```
При успешном выполнении должен быть текст, как и при первом curl-запросе:

   В случае успеха должно появиться сообщение (Если ввели число X)
   ```
   "Response: {X + 1}. Number {X} has been added to the database."
   ```
   Если до демонстрации уже добавляли числа, возможны два других ответа:
   ```
   Number {X} is already in the database (case 1)
   ```
   ИЛИ
   ```
   Number {num + 1} is already in the database (case 2)
   ```
   Если ответа нет в принципе, то все плохо
   Этого достаточно для получения галочек ENV, Docker, REST, kube, db (5 штук)

# Ошибка лимита пулов в докерхаб
0) sudo apt update && sudo apt upgrade -y
1) sudo apt install nslookup -y && sudo apt install traceroute -y
2) nslookup index.docker.io
3) Записать все ipv4 (У меня, например, так {у вас могут отличаться}): 54.198.86.24. 54.236.113.205, 54.227.20.253). Айпи с буквами (abcf) игнорировать
4) ip route | grep default
Найти свой айпи (например, 192.168.0.1)
5) traceroute index.docker.io  
Заскринить результаты
6) Подставить сюда айпи докера и свое дефолт айпи и выполнить команды   
sudo ip route add <IP_DOCKER_1> via <DEFAULT_IP>  
sudo ip route add <IP_DOCKER_1> via <DEFAULT_IP>  
sudo ip route add <IP_DOCKER_1> via <DEFAULT_IP>
7) traceroute index.docker.io  
Заскринить результаты. Сравнить с пунктом 5. Если последовательности адресов отличаются, то все ок
8) Delete, apply, посмотреть, загрузится файл или нет

# Если у меня свое приложение и бд

В случае использования собственного кода, как правило, изменения заключаются в конфигурации yml-файлов:

Само собой подразумевается, что namespace везде меняется на свой, имена деплоям, сервисам и ингресам задаются такие, которые удобны для вас
Ключевые изменения:    
1) Для бд: указать свои переменные среды, образ своей бд из докерхаба
2) Для приложения: указать свои переменные среды, свой образ из докерхаба, указать свои порты (которые использует приложение для кода)
3) Для ингреса: указать свой хост-нейм, указать свой путь (хвостик REST), указать имя своего сервиса (см yml файл приложения, раздел Service), указать используемый порт

Примеры файлов с конфигурацией:  
1) [GitHub URL](https://github.com/cldcdr42/W_for_wget/blob/main/apps/postgress/temp2-pg.yml) бд postgres (postgres.yml)
2) [GitHub URL](https://github.com/cldcdr42/W_for_wget/blob/main/apps/postgress/temp2-py.yml) приложения на пайтоне (flask) (python.yml)
3) [GitHub URL](https://github.com/cldcdr42/W_for_wget/blob/main/apps/postgress/ing.yml) Ингрес (ingress.yml)
